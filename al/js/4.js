var dataJson = {
  "type": "FeatureCollection",
  "features": [
    {"type": "Apteka", "id": 0, "geometry": {"type": "Point", "coordinates": [55.831903, 37.411961]}, "properties": {"qq": 3, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=1' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 1, "geometry": {"type": "Point", "coordinates": [55.763338, 37.565466]}, "properties": {"qq": 3, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=2' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 2, "geometry": {"type": "Point", "coordinates": [55.763338, 37.565466]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=3' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 3, "geometry": {"type": "Point", "coordinates": [55.744522, 37.616378]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=4' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 4, "geometry": {"type": "Point", "coordinates": [55.780898, 37.642889]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=5' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 5, "geometry": {"type": "Point", "coordinates": [55.793559, 37.435983]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=6' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 6, "geometry": {"type": "Point", "coordinates": [55.800584, 37.675638]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=7' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 7, "geometry": {"type": "Point", "coordinates": [55.716733, 37.589988]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=8' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 8, "geometry": {"type": "Point", "coordinates": [55.775724, 37.56084]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=9' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 9, "geometry": {"type": "Point", "coordinates": [55.822144, 37.433781]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=10' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 10, "geometry": {"type": "Point", "coordinates": [55.87417, 37.669838]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=11' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 11, "geometry": {"type": "Point", "coordinates": [55.71677, 37.482338]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=12' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 12, "geometry": {"type": "Point", "coordinates": [55.78085, 37.75021]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=13' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 13, "geometry": {"type": "Point", "coordinates": [55.810906, 37.654142]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=14' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 14, "geometry": {"type": "Point", "coordinates": [55.865386, 37.713329]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=15' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 15, "geometry": {"type": "Point", "coordinates": [55.847121, 37.525797]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=16' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 16, "geometry": {"type": "Point", "coordinates": [55.778655, 37.710743]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=17' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 17, "geometry": {"type": "Point", "coordinates": [55.623415, 37.717934]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=18' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 18, "geometry": {"type": "Point", "coordinates": [55.863193, 37.737]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=19' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}},
    {"type": "Feature", "id": 19, "geometry": {"type": "Point", "coordinates": [55.86677, 37.760113]}, "properties": {"qq": 2, "balloonContent": "<a class='map-popover-link' data-fancybox='group' data-src='#testid' href='javascript:;'><img src='https://placehold.it/200x100?text=20' alt=''></a>", "clusterCaption": "Еще одна метка", "hintContent": "Текст подсказки"}}
  ]
};

$(function() {
    ymaps.ready(init);
});

function init() {

    var myMap;
    var coords;
    var zoom;
    var geolocation = ymaps.geolocation;
    // координаты
    if(typeof(geolocation.latitude) != 'undefined' || typeof(geolocation.longitude) != 'undefined')
    {
        coords = [geolocation.latitude, geolocation.longitude];
        zoom = 8;
    }
    else
    {
        coords = [55.67648539089637, 37.57094863850402];
        zoom = 5;
    }

    myMap = new ymaps.Map("map", {
        center: coords,
        zoom: zoom,
        controls: ['zoomControl', 'searchControl', 'fullscreenControl', 'geolocationControl']
    },{
        searchControlProvider: 'yandex#search'
    }),
        objectManager = new ymaps.ObjectManager({
            // Чтобы метки начали кластеризоваться, выставляем опцию.
            clusterize: true,
            // ObjectManager принимает те же опции, что и кластеризатор.
            gridSize: 32,
            clusterBalloonContentLayout: "cluster#balloonCarousel",
            clusterIconLayout: ymaps.templateLayoutFactory.createClass('<div class="cluster-icon" style="color: red; background-color: #fff;">{{ properties.geoObjects.length }}</div>'),
            clusterIconShape: {
                type: 'Rectangle',
                coordinates: [[0, 0], [30, 30]]
            }
    });



    myMap.behaviors.disable('scrollZoom');
    myMap.controls.add("zoomControl", {
        position: {top: 15, left: 15}
    });

//*****
  MyBalloonLayout = ymaps.templateLayoutFactory.createClass(
            '<div class="popover top">' +
                '<div class="popover-inner">' +
                '$[[options.contentLayout observeSize minWidth=235 maxWidth=235 maxHeight=350]]' +
                '</div>' +
                '</div>', {
                /**
                 * Строит экземпляр макета на основе шаблона и добавляет его в родительский HTML-элемент.
                 * @see https://api.yandex.ru/maps/doc/jsapi/2.1/ref/reference/layout.templateBased.Base.xml#build
                 * @function
                 * @name build
                 */
                build: function () {
                    this.constructor.superclass.build.call(this);

                    this._$element = $('.popover', this.getParentElement());

                    this.applyElementOffset();

                    this._$element.find('.close')
                        .on('click', $.proxy(this.onCloseClick, this));
                },

                /**
                 * Удаляет содержимое макета из DOM.
                 * @see https://api.yandex.ru/maps/doc/jsapi/2.1/ref/reference/layout.templateBased.Base.xml#clear
                 * @function
                 * @name clear
                 */
                clear: function () {
                    this._$element.find('.close')
                        .off('click');

                    this.constructor.superclass.clear.call(this);
                },

                /**
                 * Метод будет вызван системой шаблонов АПИ при изменении размеров вложенного макета.
                 * @see https://api.yandex.ru/maps/doc/jsapi/2.1/ref/reference/IBalloonLayout.xml#event-userclose
                 * @function
                 * @name onSublayoutSizeChange
                 */
                onSublayoutSizeChange: function () {
                    MyBalloonLayout.superclass.onSublayoutSizeChange.apply(this, arguments);

                    if(!this._isElement(this._$element)) {
                        return;
                    }

                    this.applyElementOffset();

                    this.events.fire('shapechange');
                },

                /**
                 * Сдвигаем балун, чтобы "хвостик" указывал на точку привязки.
                 * @see https://api.yandex.ru/maps/doc/jsapi/2.1/ref/reference/IBalloonLayout.xml#event-userclose
                 * @function
                 * @name applyElementOffset
                 */
                applyElementOffset: function () {
                    this._$element.css({
                        left: -(this._$element[0].offsetWidth / 2),
                        top: -(this._$element[0].offsetHeight + this._$element.find('.arrow')[0].offsetHeight)
                    });
                },

                /**
                 * Закрывает балун при клике на крестик, кидая событие "userclose" на макете.
                 * @see https://api.yandex.ru/maps/doc/jsapi/2.1/ref/reference/IBalloonLayout.xml#event-userclose
                 * @function
                 * @name onCloseClick
                 */
                onCloseClick: function (e) {
                    e.preventDefault();

                    this.events.fire('userclose');
                },

                /**
                 * Используется для автопозиционирования (balloonAutoPan).
                 * @see https://api.yandex.ru/maps/doc/jsapi/2.1/ref/reference/ILayout.xml#getClientBounds
                 * @function
                 * @name getClientBounds
                 * @returns {Number[][]} Координаты левого верхнего и правого нижнего углов шаблона относительно точки привязки.
                 */
                getShape: function () {
                    if(!this._isElement(this._$element)) {
                        return MyBalloonLayout.superclass.getShape.call(this);
                    }

                    var position = this._$element.position();

                    return new ymaps.shape.Rectangle(new ymaps.geometry.pixel.Rectangle([
                        [position.left, position.top], [
                            position.left + this._$element[0].offsetWidth,
                            position.top + this._$element[0].offsetHeight + this._$element.find('.arrow')[0].offsetHeight
                        ]
                    ]));
                },

                /**
                 * Проверяем наличие элемента (в ИЕ и Опере его еще может не быть).
                 * @function
                 * @private
                 * @name _isElement
                 * @param {jQuery} [element] Элемент.
                 * @returns {Boolean} Флаг наличия.
                 */
                _isElement: function (element) {
                    return element && element[0] && element.find('.arrow')[0];
                }
            });
//*****

    // Чтобы задать опции одиночным объектам и кластерам,
    // обратимся к дочерним коллекциям ObjectManager.
    objectManager.objects.options.set({
     // Опции.
        // Необходимо указать данный тип макета.
        iconLayout: 'default#image',
        // Своё изображение иконки метки.
        iconImageHref: 'http://www.jonedmiston.com/wp-content/uploads/2012/09/octocat.png',
        // Размеры метки.
        iconImageSize: [30, 42],
        // Смещение левого верхнего угла иконки относительно
        // её "ножки" (точки привязки).
        iconImageOffset: [-3, -42],
        balloonLayout: MyBalloonLayout
    });
    // objectManager.clusters.options.set('preset', 'islands#invertedVioletClusterIcons');
    myMap.geoObjects.add(objectManager);
    // objectManager.setFilter('properties.qq == "3"');


    $('.custom-control-input').on('input change click', function (e) {
      var objectId = $(this).is(':checked') ? $(this).val() : '';
      $('.custom-control-input').not(this).prop('checked', false);
      objectManager.setFilter(function (obj) {
        return !objectId || obj.properties.qq == objectId;
      });
    });

    objectManager.add(dataJson);

    $(document).on('click', '.map-popover-link', function (e) {
        e.preventDefault();
        console.log('adasd');
        // alert($(this).attr('href'));
    });
}
